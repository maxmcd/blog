<!DOCTYPE html>
<html lang="en-us">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<meta http-equiv="X-UA-Compatible" content="ie=edge">
	<meta name="theme-color" content="#494f5c">
	<meta name="msapplication-TileColor" content="#494f5c">
<meta itemprop="name" content="Strategies for Binary Relocation In Functional Build Systems">
<meta itemprop="description" content="I&rsquo;m currently writing a toy Nix/Guix called Bramble to learn more about the inner workings of both systems. One of the features that I wanted to include in my version was &ldquo;binary relocation&rdquo;.
Both Nix and Guix have hardcoded store paths that are baked into all the outputs that they produce. If we take a look at part of a simple nix Derivation you&rsquo;ll see that these paths are hardcoded directly in the file."><meta itemprop="datePublished" content="2020-06-29T01:29:25&#43;00:00" />
<meta itemprop="dateModified" content="2020-07-02T21:50:11-04:00" />
<meta itemprop="wordCount" content="880">
<meta itemprop="keywords" content="build,bazel,nix,guix," /><meta property="og:title" content="Strategies for Binary Relocation In Functional Build Systems" />
<meta property="og:description" content="I&rsquo;m currently writing a toy Nix/Guix called Bramble to learn more about the inner workings of both systems. One of the features that I wanted to include in my version was &ldquo;binary relocation&rdquo;.
Both Nix and Guix have hardcoded store paths that are baked into all the outputs that they produce. If we take a look at part of a simple nix Derivation you&rsquo;ll see that these paths are hardcoded directly in the file." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://maxmcd.com/posts/strategies-for-binary-relocation/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2020-06-29T01:29:25&#43;00:00" />
<meta property="article:modified_time" content="2020-07-02T21:50:11-04:00" />

<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Strategies for Binary Relocation In Functional Build Systems"/>
<meta name="twitter:description" content="I&rsquo;m currently writing a toy Nix/Guix called Bramble to learn more about the inner workings of both systems. One of the features that I wanted to include in my version was &ldquo;binary relocation&rdquo;.
Both Nix and Guix have hardcoded store paths that are baked into all the outputs that they produce. If we take a look at part of a simple nix Derivation you&rsquo;ll see that these paths are hardcoded directly in the file."/>

<link rel="shortcut icon" href="/favicon.png">

	<title>Strategies for Binary Relocation In Functional Build Systems</title>
	<link rel="stylesheet" href="https://maxmcd.com/css/style.min.409c66fcafe8b09906d6960a3634f6d840e9f7e583d8b318a81fe7722155f39a.css" integrity="sha256-QJxm/K/osJkG1pYKNjT22EDp9+WD2LMYqB/nciFV85o=" crossorigin="anonymous">
	
</head>

<body id="page">
	
	<header id="site-header" class="animated slideInUp">
		<div class="hdr-wrapper section-inner">
			<div class="hdr-left">
				<div class="site-branding">
					<a href="https://maxmcd.com">Max McDonnell</a>
				</div>
				<nav class="site-nav hide-in-mobile">
					
				<a href="https://maxmcd.com/posts/">Posts</a>
				<a href="https://maxmcd.com/about/">About</a>

				</nav>
			</div>
			<div class="hdr-right hdr-icons">
				<span class="hdr-social hide-in-mobile"><a href="https://twitter.com/mxmcd" target="_blank" rel="noopener me" title="Twitter"><svg xmlns="http://www.w3.org/2000/svg" class="feather" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M23 3a10.9 10.9 0 0 1-3.14 1.53 4.48 4.48 0 0 0-7.86 3v1A10.66 10.66 0 0 1 3 4s-4 9 5 13a11.64 11.64 0 0 1-7 2c9 5 20 0 20-11.5a4.5 4.5 0 0 0-.08-.83A7.72 7.72 0 0 0 23 3z"></path></svg></a><a href="https://github.com/maxmcd" target="_blank" rel="noopener me" title="Github"><svg xmlns="http://www.w3.org/2000/svg" class="feather" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 0 0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0 0 20 4.77 5.07 5.07 0 0 0 19.91 1S18.73.65 16 2.48a13.38 13.38 0 0 0-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07 0 0 0 5 4.77a5.44 5.44 0 0 0-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37 0 0 0 9 18.13V22"></path></svg></a></span><button id="menu-btn" class="hdr-btn" title="Menu"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-menu"><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line></svg></button>
			</div>
		</div>
	</header>
	<div id="mobile-menu" class="animated fast">
		<ul>
			<li><a href="https://maxmcd.com/posts/">Posts</a></li>
			<li><a href="https://maxmcd.com/about/">About</a></li>
		</ul>
	</div>


	<main class="site-main section-inner animated fadeIn faster">
		<article class="thin">
			<header class="post-header">
				<div class="post-meta"><span>Jun 29, 2020</span> - Max McDonnell</div>
				<h1>Strategies for Binary Relocation In Functional Build Systems</h1>
			</header>
			<div class="content">
				<p>I&rsquo;m currently writing a toy Nix/Guix called <a href="github.com/maxmcd/bramble">Bramble</a> to learn more about the inner workings of both systems. One of the features that I wanted to include in my version was &ldquo;binary relocation&rdquo;.</p>
<p>Both Nix and Guix have hardcoded store paths that are baked into all the outputs that they produce. If we take a look at part of a <a href="https://gist.github.com/maxmcd/d98710a0e26daaff37c565da599f5d76">simple nix Derivation</a> you&rsquo;ll see that these paths are hardcoded directly in the file. This is an important component of Nix. Instead of searching for the default shared libraries on a system nix-built binaries are patched to only include the specific libraries they depend on. This helps ensure correctness but also means that the binary must know exactly where to look for the shared lib. Hardcoding a library path to a fixed known location like <code>/nix/store/zqi5prhap0qh6r4nkghnibbmkgn7sczf-libogg-1.3.4/lib/</code> is an elegant way to get this done.</p>
<p>So what is binary relocation? If Nix supported binary relocation it would support moving Nix artifacts to a new location, somewhere that is not <code>/nix/store</code>. Generally, nix doesn&rsquo;t support this. You can take advantage of <a href="https://github.com/NixOS/nix/issues/1971#issuecomment-372542326">workarounds</a> to fake it, but when nix is running it must think that <code>/nix/store</code> is the place to check for things.</p>
<p>So why do we want binary relocation? My simple answer is that I want Bramble to not require root access. If we want a user to be able to put their store in <code>/home/human/store</code> we&rsquo;ll need some way to rewrite that path for different users. Outside of that it would also provide future flexibility in the face of issues <a href="https://github.com/NixOS/nix/issues/2925">like this one</a>.</p>
<p>I&rsquo;ll outline the solutions to this problem that I&rsquo;ve been able to find, and then summarize what I&rsquo;m using for my system.</p>
<h2 id="just-use-relative-paths">Just use relative paths<a href="#just-use-relative-paths" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path><line x1="8" y1="12" x2="16" y2="12"></line></svg></a></h2>
<p>I was originally very optimistic about this idea. All build outputs would expect to run from within the bramble store and if they needed a library they would point to the relative path of the library they need. Patching the <a href="https://en.wikipedia.org/wiki/Rpath">rpath</a> of a binary with the $ORIGIN environment variable allows us to use this this strategy within executables.</p>
<p>Seemed like all I needed to do from here was be careful with my build scripts and ensure there were tools to help others easily write relative paths into their builds.</p>
<p>In practice I found this very difficult to do. This is apparently what Bazel does and there is some <a href="https://discourse.nixos.org/t/can-origin-be-used-to-make-nix-prebuilt-binaries-relocatable/2853/5">interesting discussion about this problem</a>.</p>
<p>Bazel is very opinionated and comes pre-baked with tools to build various languages. If I was writing a tool like that then this might very well be the best way to go. However, Bramble is intended to be like Nix, where end users are expected to write build scripts, and I couldn&rsquo;t figure out a easy way to execute on this without complicating even the simplest builds.</p>
<h2 id="just-re-patch-everything">Just re-patch everything<a href="#just-re-patch-everything" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path><line x1="8" y1="12" x2="16" y2="12"></line></svg></a></h2>
<p><strong>edit: I clearly didn&rsquo;t read enough about Spack&rsquo;s implementation. Spack&rsquo;s creator <a href="https://lobste.rs/s/2lnncd/strategies_for_binary_relocation#c_btkgc0">posted a response to this post</a> with some very nice details.</strong></p>
<p>The <a href="https://github.com/spack/spack">spack</a> build tool support binary relocation: <a href="https://spack.readthedocs.io/en/latest/binary_caches.html#relocation">https://spack.readthedocs.io/en/latest/binary_caches.html#relocation</a></p>
<p>You can read through the implementation <a href="https://github.com/spack/spack/blob/f5467957bca49ca612cfc32710ed2ca8a943583d/lib/spack/spack/relocate.py">here</a>. Spack just goes through and uses <code>pathelf</code> and <code>install_name_tool</code> to rewrite the applicable paths. This is interesting, and might work, but for the moment seems like it would miss various other paths within scripts or configuration. Spack mentions this:</p>
<blockquote>
<p>However, many packages compile paths into binary artifacts directly. In such cases, the build instructions of this package would need to be adjusted for better re-locatability.</p>
</blockquote>
<p>This might be worth exploring at a later date, maybe testing against various packages as they&rsquo;re build. For the moment it seems like a non-starter because of the difficulties of trivially replacing paths that are not in binaries.</p>
<h2 id="pad-the-path">Pad the path<a href="#pad-the-path" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path><line x1="8" y1="12" x2="16" y2="12"></line></svg></a></h2>
<p>One interesting observation here <a href="https://github.com/NixOS/nix/issues/1971">https://github.com/NixOS/nix/issues/1971</a> what that <code>/nix/store/</code> and <code>/tmp/foo///</code> are both valid paths of the same length. If you could guarantee that your path was always shorter than a certain length you could just pad the location with slashes. Or, if the path is longer, you could store everything in a short path symlink the the longer path to that path.</p>
<p>This is roughly the solution I ended up going with. Instead of using something like <code>/nix/store</code> I would assume the user can install their store within their home directory. The path would then be something like <code>/home/maxm/.bramble/store</code> or <code>/Users/maxm/.bramble/store/</code> for macOS. Now, instead of using &ldquo;store&rdquo; we rename that folder so that the length of the path is always the same. Here are some examples:</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash">/home/maxm/.bramble/soooooooooooooooooooooooooooo/
/Users/maxm/.bramble/sooooooooooooooooooooooooooo/

<span class="c1"># Linux/OpenBSD usernames can&#39;t be longer than 32 characters</span>
/home/00000000001111111111000000000011/.bramble/s/
<span class="c1"># Darwin/macOS has a limit of 20</span>
/Users/00000000001111111111/.bramble/sooooooooooo/
</code></pre></div><p>This way, the path length is always the same, so it&rsquo;s easy for us to find it within build outputs and patch it to be something else. Changing a users username or changing the store location will now mean all build outputs need to be patched, but there is at least a clear path to do so.</p>
<h2 id="summary">Summary<a href="#summary" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path><line x1="8" y1="12" x2="16" y2="12"></line></svg></a></h2>
<p>I&rsquo;m going to try out this path padding thing. Part of the reason I wrote up this post is because this feels like a ridiculous direction to go down. What do you think? Are there ways to get binary relocation that I&rsquo;m missing? Should I spend more time on relative paths and re-patching? Are there pieces here I&rsquo;m not thinking about?</p>

			</div>
			<hr class="post-end">
			<footer class="post-info">
				<p>
					<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-tag meta-icon"><path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"></path><line x1="7" y1="7" x2="7" y2="7"></line></svg><span class="tag"><a href="https://maxmcd.com/tags/build">build</a></span><span class="tag"><a href="https://maxmcd.com/tags/bazel">bazel</a></span><span class="tag"><a href="https://maxmcd.com/tags/nix">nix</a></span><span class="tag"><a href="https://maxmcd.com/tags/guix">guix</a></span>
				</p>
				<p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-file-text"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></svg>880 Words</p>
				<p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-calendar"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>2020-06-28 21:29 UTC</p>
				<p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-git-commit"><circle cx="12" cy="12" r="4"></circle><line x1="1.05" y1="12" x2="7" y2="12"></line><line x1="17.01" y1="12" x2="22.96" y2="12"></line></svg><a href="https://github.com/maxmcd/blog/commit/c0d278b3007acdcee914b06a72e5f410de0d3383" target="_blank" rel="noopener">c0d278b</a> @ 2020-07-02</p>
			</footer>
		</article>
		<aside id="toc">
			<div class="toc-title">Table of Contents</div>
			<nav id="TableOfContents">
  <ul>
    <li><a href="#just-use-relative-paths">Just use relative paths</a></li>
    <li><a href="#just-re-patch-everything">Just re-patch everything</a></li>
    <li><a href="#pad-the-path">Pad the path</a></li>
    <li><a href="#summary">Summary</a></li>
  </ul>
</nav>
		</aside>
		<div class="post-nav thin">
			<a class="prev-post" href="https://maxmcd.com/posts/star/">
				<span class="post-nav-label"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-arrow-left"><line x1="19" y1="12" x2="5" y2="12"></line><polyline points="12 19 5 12 12 5"></polyline></svg>&nbsp;Older</span><br><span>Star: Go but in Python?</span>
			</a>
		</div>
		<div id="comments" class="thin">
</div>
	</main>

	<footer id="site-footer" class="section-inner thin animated fadeIn faster">
		<p>
				<a href="https://maxmcd.com/posts/index.xml" target="_blank" title="rss">
					<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-rss"><path d="M4 11a9 9 0 0 1 9 9"></path><path d="M4 4a16 16 0 0 1 16 16"></path><circle cx="5" cy="19" r="1"></circle></svg>
				</a>
			
		</p>
	</footer>



	<script src="https://maxmcd.com/js/bundle.min.7d8545daa55d62427355498dd8da13f98ff79a7938ce7d2a5e2ae1ec0de3beb8.js" integrity="sha256-fYVF2qVdYkJzVUmN2NoT+Y/3mnk4zn0qXirh7A3jvrg=" crossorigin="anonymous"></script>
	

</body>

</html>
