<!DOCTYPE html>
<html lang="en-us">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<meta http-equiv="X-UA-Compatible" content="ie=edge">
	<meta name="theme-color" content="#494f5c">
	<meta name="msapplication-TileColor" content="#494f5c">
<meta itemprop="name" content="Let&#39;s make a Nix/Guix">
<meta itemprop="description" content="Nix (and the more recently created GNU Guix) are functional package managers. I&rsquo;ve used NixOS for some time now and have thoroughly enjoyed using it. I was inspired by Andrew Chamber&rsquo;s recently launched hermes to try implementing a simple version of Nix using Go and Starlark.
A quick overview of Nix/Guix Nix and Guix are package managers that &ldquo;utilize a purely functional deployment model where software is installed into unique directories generated through cryptographic hashes.">
<meta itemprop="datePublished" content="2020-06-19T01:29:25&#43;00:00" />
<meta itemprop="dateModified" content="2020-06-29T19:07:49-04:00" />
<meta itemprop="wordCount" content="682">



<meta itemprop="keywords" content="build,starlark,go,nix,guix,hermes," /><meta property="og:title" content="Let&#39;s make a Nix/Guix" />
<meta property="og:description" content="Nix (and the more recently created GNU Guix) are functional package managers. I&rsquo;ve used NixOS for some time now and have thoroughly enjoyed using it. I was inspired by Andrew Chamber&rsquo;s recently launched hermes to try implementing a simple version of Nix using Go and Starlark.
A quick overview of Nix/Guix Nix and Guix are package managers that &ldquo;utilize a purely functional deployment model where software is installed into unique directories generated through cryptographic hashes." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://maxmcd.com/posts/lets-make-a-nix-guix/" />
<meta property="article:published_time" content="2020-06-19T01:29:25+00:00" />
<meta property="article:modified_time" content="2020-06-29T19:07:49-04:00" />
<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Let&#39;s make a Nix/Guix"/>
<meta name="twitter:description" content="Nix (and the more recently created GNU Guix) are functional package managers. I&rsquo;ve used NixOS for some time now and have thoroughly enjoyed using it. I was inspired by Andrew Chamber&rsquo;s recently launched hermes to try implementing a simple version of Nix using Go and Starlark.
A quick overview of Nix/Guix Nix and Guix are package managers that &ldquo;utilize a purely functional deployment model where software is installed into unique directories generated through cryptographic hashes."/>

<link rel="shortcut icon" href="/favicon.png">

	<title>Let&#39;s make a Nix/Guix</title>
	<link rel="stylesheet" href="https://maxmcd.com/css/style.min.c3c1dc47350d651aa2786a8532ff063ffc88db7365580e26ea1bb752c9a8a2b8.css" integrity="sha256-w8HcRzUNZRqieGqFMv8GP/yI23NlWA4m6hu3Usmoorg=" crossorigin="anonymous">
	
</head>

<body id="page">
	
	<header id="site-header" class="animated slideInUp">
		<div class="hdr-wrapper section-inner">
			<div class="hdr-left">
				<div class="site-branding">
					<a href="https://maxmcd.com">Max McDonnell</a>
				</div>
				<nav class="site-nav hide-in-mobile">
					
				<a href="https://maxmcd.com/posts/">Posts</a>
				<a href="https://maxmcd.com/about/">About</a>

				</nav>
			</div>
			<div class="hdr-right hdr-icons">
				<span class="hdr-social hide-in-mobile"><a href="https://twitter.com/mxmcd" target="_blank" rel="noopener me" title="Twitter"><svg xmlns="http://www.w3.org/2000/svg" class="feather" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M23 3a10.9 10.9 0 0 1-3.14 1.53 4.48 4.48 0 0 0-7.86 3v1A10.66 10.66 0 0 1 3 4s-4 9 5 13a11.64 11.64 0 0 1-7 2c9 5 20 0 20-11.5a4.5 4.5 0 0 0-.08-.83A7.72 7.72 0 0 0 23 3z"></path></svg></a><a href="https://github.com/maxmcd" target="_blank" rel="noopener me" title="Github"><svg xmlns="http://www.w3.org/2000/svg" class="feather" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 0 0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0 0 20 4.77 5.07 5.07 0 0 0 19.91 1S18.73.65 16 2.48a13.38 13.38 0 0 0-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07 0 0 0 5 4.77a5.44 5.44 0 0 0-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37 0 0 0 9 18.13V22"></path></svg></a></span><button id="menu-btn" class="hdr-btn" title="Menu"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-menu"><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line></svg></button>
			</div>
		</div>
	</header>
	<div id="mobile-menu" class="animated fast">
		<ul>
			<li><a href="https://maxmcd.com/posts/">Posts</a></li>
			<li><a href="https://maxmcd.com/about/">About</a></li>
		</ul>
	</div>


	<main class="site-main section-inner animated fadeIn faster">
		<article class="thin">
			<header class="post-header">
				<div class="post-meta"><span>Jun 19, 2020</span> - Max McDonnell</div>
				<h1>Let&#39;s make a Nix/Guix</h1>
			</header>
			<div class="content">
				<p><a href="https://nixos.org/">Nix</a> (and the more recently created <a href="https://guix.gnu.org/">GNU Guix</a>) are functional package managers. I&rsquo;ve used NixOS for some time now and have thoroughly enjoyed using it. I was inspired by Andrew Chamber&rsquo;s recently launched <a href="https://acha.ninja/blog/introducing_hermes/">hermes</a> to try implementing a simple version of Nix using Go and <a href="https://docs.bazel.build/versions/master/skylark/language.html">Starlark</a>.</p>
<h2 id="a-quick-overview-of-nixguix">A quick overview of Nix/Guix<a href="#a-quick-overview-of-nixguix" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path><line x1="8" y1="12" x2="16" y2="12"></line></svg></a></h2>
<p>Nix and Guix are package managers that &ldquo;utilize a purely functional deployment model where software is installed into unique directories generated through cryptographic hashes.&quot;<sup id="fnref:1"><a href="#fn:1" class="footnote-ref" role="doc-noteref">1</a></sup></p>
<p>Let&rsquo;s dig into that description with a quick example. We&rsquo;ll pretend we&rsquo;re trying to install two libraries &ldquo;Blue&rdquo; and &ldquo;Green&rdquo; that require ruby to run. On a normal system you might first install Blue which relies on ruby-2.6.5. You run <code>install Blue</code> and the package manager downloads ruby-2.6.5 for you along with your dependency. The dependency works and everyone is happy.</p>
<p>Next you go to download Green and it fails with the following error:</p>
<pre><code>Resolving dependencies...
green requires ruby version &gt;= 2.0, &lt; 2.6, which is
incompatible with the current version, ruby 2.6.5
</code></pre><p>You realize that this software can&rsquo;t run with ruby 2.6.5 yet. You file a bug with the project, hope for a resolution one day and move on to thinking about downgrading ruby or using RVM to solve your problem.</p>
<p>Nix has a solution to this issue. You run <code>nix-env -iA nixpkgs.blue</code> and <code>nix-env -iA nixpkgs.green</code> and it downloads the following assets (folders with hashes in their names):</p>
<pre><code>12a7h4w68f96j56kzwxxpxbc4zq7n76p-ruby-2.6.5
bqrxcg5a9hv5gb6527vmsay871fi22qv-blue-1.7.8
mxaxvp33wg9sim8qh2kkw041v492bvxj-green-0.9.10
94544v143cpp17s7kl6g9y39x2a09k51-ruby-2.5.7
</code></pre><p>Two versions of ruby right on your system. When you run Blue it knows to use the ruby in folder 12a7h4w68f96j56kzwxxpxbc4zq7n76p-ruby-2.6.5 and when you run Green it uses 94544v143cpp17s7kl6g9y39x2a09k51-ruby-2.5.7. Essentially you solve the issue of <a href="https://en.wikipedia.org/wiki/Dependency_hell">dependency hell</a> at the cost of some additional disk space.</p>
<p>Expanding from this basic idea, you can think about how this strategy is used throughout Nix. Every piece of software built with Nix outputs a hashed folder (or <a href="https://nixos.org/nixos/nix-pills/our-first-derivation.html#idm140737320470112">folders</a>). When a piece of software is run it uses the specific folders it relies on. If you want to build a new piece of software you point to certain hashed folders to build the dependency and other hashed folders to use as runtime dependencies.</p>
<p>This allows users of Nix to ask some pretty wild things of its system:</p>
<ol>
<li>Delete all the dependencies I&rsquo;m not using</li>
<li>Roll back my entire system to a previous set of dependencies</li>
<li>Delete all the build dependencies I just downloaded but keep the dependencies my applications need</li>
</ol>
<p>Additionally, because inputs, outputs and the running environment are known, it&rsquo;s easy to build things in advance, cache them, and just let the user download the resulting build files. This is what happens when you run <code>nix-env -iA nixpkgs.ruby</code>, the Nix build script likely builds ruby from source with dozens of build-time dependencies, but as an end user I just need the build result.</p>
<h2 id="lets-build-one">Let&rsquo;s build one<a href="#lets-build-one" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path><line x1="8" y1="12" x2="16" y2="12"></line></svg></a></h2>
<p>Each of these package managers use purely functional configuration languages to For each of use let&rsquo;s go  with starlark for the config language. Starlark is a subset of python and
should hopefully be easy for others to learn.</p>
<p>We&rsquo;ll need to figure out how to build the seed. The first executable that will start building other libraries. We&rsquo;ll need a libc
and a compiler. glibc and clang</p>
<p>TODO look at seeds for guix/nix/others</p>
<p>Let&rsquo;s pick x and y.</p>
<p>Now let&rsquo;s make our first build, we&rsquo;re going to have to decide a few things right off the bat.</p>
<p>What does the scripting api look like
What does the input hashing look like
How do we make network calls and verify hashes</p>
<p>Explain nix derivations, hermes input hashing</p>
<p>(apologize for not knowing about guix)</p>
<p>We should sandbox but we can skip it for now</p>
<p><a href="https://nixos.org/nix/manual/#ssec-derivation">https://nixos.org/nix/manual/#ssec-derivation</a></p>
<blockquote>
<p>If the build was successful, Nix scans each output path for references to input paths by looking for the hash parts of the input paths. Since these are potential runtime dependencies, Nix registers them as dependencies of the output paths.</p>
</blockquote>
<p>Build the thing, scan all the output paths for sources, mark them in gc.</p>
<p>Build a language from the seed</p>
<p>Build a program for the language</p>
<section class="footnotes" role="doc-endnotes">
<hr>
<ol>
<li id="fn:1" role="doc-endnote">
<p><a href="https://en.wikipedia.org/wiki/Nix_package_manager">https://en.wikipedia.org/wiki/Nix_package_manager</a> <a href="#fnref:1" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
</ol>
</section>

			</div>
			<hr class="post-end">
			<footer class="post-info">
				<p>
					<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-tag meta-icon"><path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"></path><line x1="7" y1="7" x2="7" y2="7"></line></svg><span class="tag"><a href="https://maxmcd.com/tags/build">build</a></span><span class="tag"><a href="https://maxmcd.com/tags/starlark">starlark</a></span><span class="tag"><a href="https://maxmcd.com/tags/go">go</a></span><span class="tag"><a href="https://maxmcd.com/tags/nix">nix</a></span><span class="tag"><a href="https://maxmcd.com/tags/guix">guix</a></span><span class="tag"><a href="https://maxmcd.com/tags/hermes">hermes</a></span>
				</p>
				<p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-file-text"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></svg>682 Words</p>
				<p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-calendar"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>2020-06-18 21:29 UTC</p>
				<p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-git-commit"><circle cx="12" cy="12" r="4"></circle><line x1="1.05" y1="12" x2="7" y2="12"></line><line x1="17.01" y1="12" x2="22.96" y2="12"></line></svg><a href="https://github.com/maxmcd/blog/commit/97e444ced335c181d9998b032b568a1d6f4cf9b7" target="_blank" rel="noopener">97e444c</a> @ 2020-06-29</p>
			</footer>
		</article>
		<aside id="toc">
			<div class="toc-title">Table of Contents</div>
			<nav id="TableOfContents">
  <ul>
    <li><a href="#a-quick-overview-of-nixguix">A quick overview of Nix/Guix</a></li>
    <li><a href="#lets-build-one">Let&rsquo;s build one</a></li>
  </ul>
</nav>
		</aside>
		<div class="post-nav thin">
			<a class="next-post" href="https://maxmcd.com/posts/strategies-for-binary-relocation/">
				<span class="post-nav-label">Newer&nbsp;<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-arrow-right"><line x1="5" y1="12" x2="19" y2="12"></line><polyline points="12 5 19 12 12 19"></polyline></svg></span><br><span>Strategies for Binary Relocation In Functional Build Systems</span>
			</a>
			<a class="prev-post" href="https://maxmcd.com/posts/star/">
				<span class="post-nav-label"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-arrow-left"><line x1="19" y1="12" x2="5" y2="12"></line><polyline points="12 19 5 12 12 5"></polyline></svg>&nbsp;Older</span><br><span>Star: Go but in Python?</span>
			</a>
		</div>
		<div id="comments" class="thin">
</div>
	</main>

	<footer id="site-footer" class="section-inner thin animated fadeIn faster">
		<p>
				<a href="https://maxmcd.com/posts/index.xml" target="_blank" title="rss">
					<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-rss"><path d="M4 11a9 9 0 0 1 9 9"></path><path d="M4 4a16 16 0 0 1 16 16"></path><circle cx="5" cy="19" r="1"></circle></svg>
				</a>
			
		</p>
	</footer>



	<script src="https://maxmcd.com/js/bundle.min.4a9a0ac3d2217822c7865b4161e6c2a71de1d70492264337755427898dd718f6.js" integrity="sha256-SpoKw9IheCLHhltBYebCpx3h1wSSJkM3dVQniY3XGPY=" crossorigin="anonymous"></script>
	

</body>

</html>
